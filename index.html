// --- كود Google Apps Script النهائي ---

function doGet(e) {
  var action = (e && e.parameter) ? e.parameter.action : "check";

  // 1. طلب جلب قائمة الطلاب (يتم عند فتح الموقع)
  if (action == "get_students") {
    return getStudentsData();
  } 
  // 2. طلب تسجيل الحضور
  else {
    return handleAttendance(e);
  }
}

function doPost(e) {
  return handleAttendance(e);
}

// دالة جلب الأسماء (سريعة ومخصصة للقراءة)
function getStudentsData() {
  try {
    var doc = SpreadsheetApp.getActiveSpreadsheet();
    // يجب أن يكون اسم الورقة "Students" بالضبط
    var sheet = doc.getSheetByName("Students");
    
    // إرجاع كائن فارغ إذا لم توجد الورقة
    if (!sheet) return ContentService.createTextOutput("{}").setMimeType(ContentService.MimeType.JSON);

    var data = sheet.getDataRange().getValues();
    var studentsMap = {};

    // نفترض: العمود الأول (A) للكود، العمود الثاني (B) للاسم
    // نتجاهل الصف الأول (العناوين) ونبدأ من 1
    for (var i = 1; i < data.length; i++) {
      var id = String(data[i][0]).trim();
      var name = String(data[i][1]).trim();
      if (id) studentsMap[id] = name;
    }

    return ContentService.createTextOutput(JSON.stringify(studentsMap))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (e) {
    return ContentService.createTextOutput("{}").setMimeType(ContentService.MimeType.JSON);
  }
}

// دالة تسجيل الحضور (إنشاء شيت المادة والكتابة)
function handleAttendance(e) {
  var lock = LockService.getScriptLock();
  lock.tryLock(3000); // قفل سريع لمنع التضارب

  try {
    var doc = SpreadsheetApp.getActiveSpreadsheet();
    var p = e.parameter;
    
    var subject = p.subject;
    var sheet;

    // تحديد الشيت بناءً على اسم المادة
    if (subject && subject !== "") {
      sheet = doc.getSheetByName(subject);
      if (!sheet) {
        sheet = doc.insertSheet(subject);
        sheet.appendRow(["التاريخ", "الوقت", "الاسم", "ID", "كود الجلسة", "المادة", "IP", "الموقع"]);
      }
    } else {
      sheet = doc.getSheetByName("Sheet1");
      if (!sheet) sheet = doc.insertSheet("Sheet1");
    }

    var now = new Date();
    var date = Utilities.formatDate(now, "GMT+2", "dd/MM/yyyy");
    var time = Utilities.formatDate(now, "GMT+2", "hh:mm:ss a");

    // تسجيل البيانات
    sheet.appendRow([date, time, p.name, p.id, p.code, subject, p.ip, p.location]);

    return ContentService.createTextOutput(JSON.stringify({"result":"success"}))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (e) {
    // إرجاع نجاح وهمي لعدم تعطيل الواجهة
    return ContentService.createTextOutput(JSON.stringify({"result":"success"}))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}