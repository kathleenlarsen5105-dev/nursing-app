<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>نظام كشف الحضور - كلية التمريض</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0f172a">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* --- CSS STYLES (UNCHANGED) --- */
        #desktop-blocker { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; color: #ef4444; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-family: 'Cairo'; }
        :root { --primary: #0ea5e9; --primary-dark: #0284c7; --text-main: #1e293b; --text-sub: #64748b; --glass-bg: rgba(255, 255, 255, 0.95); --danger: #ef4444; --success: #10b981; }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Cairo', sans-serif; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #0f172a; padding: 20px; color: var(--text-main); }
        .bg-image { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('https://a.top4top.io/p_36115ao3o1.jpg') center/cover; filter: blur(8px) brightness(0.8); z-index: -1; }
        .app-card { background: var(--glass-bg); width: 100%; max-width: 400px; border-radius: 24px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.3); min-height: 600px; position: relative; display: flex; flex-direction: column; }
        .card-banner { height: 140px; background: url('https://a.top4top.io/p_36115ao3o1.jpg') center/cover; position: relative; }
        .card-banner::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background: linear-gradient(to top, rgba(255,255,255,1), transparent); }
        .card-body { padding: 20px; flex-grow: 1; text-align: center; }
        .hero-icon-wrapper { width: 80px; height: 80px; background: white; border-radius: 50%; margin: -60px auto 10px auto; position: relative; z-index: 10; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); font-size: 35px; color: var(--primary); }
        h1 { font-size: 22px; font-weight: 900; color: #0f172a; margin-bottom: 5px; }
        .faculty-title { font-size: 14px; color: var(--primary); font-weight: 700; display: block; margin-bottom: 15px; }
        .input-group { margin-bottom: 15px; text-align: right; }
        .modern-input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; font-family: 'Cairo'; font-size: 15px; outline: none; background: #f8fafc; text-align: center; }
        select.modern-input { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: left 1rem center; background-size: 1em; }
        .btn-main { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-main:disabled { background: #cbd5e1; cursor: not-allowed; }
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .student-info-card { background: linear-gradient(135deg, #f8fafc, #e0f2fe); border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px -10px rgba(14, 165, 233, 0.2); border: 1px solid #bae6fd; text-align: right; position: relative; }
        .student-info-item { margin-bottom: 10px; position: relative; padding-right: 40px; z-index: 2; }
        .student-info-icon { position: absolute; right: 0; top: 50%; transform: translateY(-50%); width: 32px; height: 32px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .student-info-label { font-size: 11px; color: var(--text-sub); font-weight: 700; display: block; }
        .student-info-value { font-size: 16px; font-weight: 900; color: var(--text-main); display: block; }
        #scanIDDisplay { font-family: sans-serif; color: var(--primary-dark); }
        #qr-reader { width: 100%; border-radius: 15px; overflow: hidden; margin-bottom: 15px; display: none; }
        .receipt-box { background: #fff; border: 1px dashed #cbd5e1; border-radius: 16px; padding: 15px; text-align: right; margin-bottom: 20px; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #f1f5f9; padding-bottom: 5px; }
        .uni-watermark { position: absolute; bottom: 0; left: 0; width: 100%; height: 250px; background: url('https://a.top4top.io/p_36115ao3o1.jpg') bottom center/cover; opacity: 0.15; pointer-events: none; -webkit-mask-image: linear-gradient(to top, black, transparent); }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; padding: 20px; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; }
    </style>
</head>
<body>

<div class="app-card">
    <div class="card-banner"></div>
    <div class="card-body">
        <div class="hero-icon-wrapper"><i class="fa-solid fa-user-nurse"></i></div>
        
        <div id="screenWelcome" class="section active">
            <span class="faculty-title">جامعة الريادة - كلية التمريض</span>
            <h1>نظام الحضور الذكي</h1>
            <p>يرجى إدخال الكود الجامعي للبدء</p>
            <div class="input-group">
                <input type="number" id="uniID" class="modern-input" placeholder="الكود الجامعي (ID)">
            </div>
            <button onclick="handleLogin()" id="loginBtn" class="btn-main">تسجيل الدخول <i class="fa-solid fa-arrow-left"></i></button>
        </div>

        <div id="screenScan" class="section">
            <h1>مسح رمز الحضور</h1>
            <div class="student-info-card">
                <div class="student-info-item">
                    <div class="student-info-icon"><i class="fa-solid fa-user-graduate"></i></div>
                    <span class="student-info-label">الطالب</span><span class="student-info-value" id="stName">--</span>
                </div>
                <div class="student-info-item">
                    <div class="student-info-icon"><i class="fa-solid fa-id-card"></i></div>
                    <span class="student-info-label">ID</span><span class="student-info-value" id="stID" style="font-family:sans-serif;">--</span>
                </div>
            </div>

            <div class="input-group">
                <select id="yearSelect" class="modern-input" onchange="updateSubjects()">
                    <option value="" disabled selected>-- اختر الفرقة --</option>
                    <option value="first_year">الفرقة الأولى</option>
                    <option value="second_year">الفرقة الثانية</option>
                </select>
            </div>
            <div class="input-group">
                <select id="subjectSelect" class="modern-input" disabled>
                    <option value="" disabled selected>-- اختر الفرقة أولاً --</option>
                </select>
            </div>

            <div id="qr-reader"></div>
            <button onclick="startCamera()" id="camBtn" class="btn-main" style="background:#334155;">فتح الكاميرا <i class="fa-solid fa-camera"></i></button>
            <input type="hidden" id="qrResult">
            <p id="qrStatus" style="color:#10b981; font-weight:bold; display:none; margin-top:10px;">تم مسح الكود بنجاح ✅</p>
            <button onclick="submitToGoogleForms()" id="submitBtn" class="btn-main" disabled style="opacity:0.5;">تأكيد الحضور</button>
        </div>

        <div id="screenSuccess" class="section">
            <i class="fa-solid fa-circle-check" style="font-size: 60px; color: #10b981; margin-bottom: 20px;"></i>
            <h1 style="color: #10b981;">تم التسجيل بنجاح</h1>
            <div class="receipt-box">
                <div class="receipt-row"><span class="r-label">الاسم</span><span class="r-val" id="receiptName">--</span></div>
                <div class="receipt-row"><span class="r-label">المادة</span><span class="r-val" id="receiptSubject" style="color:var(--primary)">--</span></div>
                <div class="receipt-row"><span class="r-label">التاريخ</span><span class="r-val" id="receiptDate">--</span></div>
                <div class="receipt-row"><span class="r-label">الوقت</span><span class="r-val" id="receiptTime">--</span></div>
            </div>
        </div>
        
        <div class="uni-watermark"></div>
    </div>
</div>

<div id="connectionLostModal" class="modal-overlay">
    <div class="modal-box">
        <i class="fa-solid fa-wifi" style="font-size:30px; color:#ef4444; margin-bottom:10px;"></i>
        <h3>لا يوجد انترنت</h3>
        <p>يرجى التحقق من الاتصال</p>
        <button onclick="location.reload()" class="btn-main">تحديث</button>
    </div>
</div>

<script>
    // ---------------------------------------------------------
    // 1. SERVER SCRIPT (FOR READING NAMES)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyV7Z39D44wc7Zyo6O9r_GVShH1Ah7N4sMweNGPh-dv9dT_-j3GoyAGxdPHDiAOkIs7/exec";
    
    // 2. GOOGLE FORM URL (FOR SUBMITTING) - NEW FORM
    const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLScvWHhzq25mqr1SK0xQeOClbBmdM04Q2hXPaGTlp2jaa93iSQ/formResponse"; 

    // 3. ENTRY IDs (CORRECT FROM YOUR NEW FORM)
    const ENTRY_ID = "entry.1366436526";      // Student ID
    const ENTRY_NAME = "entry.1087940609";    // Student Name
    const ENTRY_SUBJECT = "entry.466865005";  // Subject
    const ENTRY_QR = "entry.119391108";       // QR Code
    // ---------------------------------------------------------

    let studentsDB = {};
    let userData = {};

    // Load Names
    fetch(SCRIPT_URL).then(r => r.json()).then(data => {
        studentsDB = data;
        localStorage.setItem('cached_students', JSON.stringify(data));
    }).catch(() => {
        const cached = localStorage.getItem('cached_students');
        if(cached) studentsDB = JSON.parse(cached);
    });

    const subjects = {
        "first_year": ["تمريض بالغين 1 نظرى", "تمريض بالغين 1 عملى", "اناتومى نظرى", "اناتومى عملى", "تقييم صحى نظرى", "تقييم صحى عملى", "مصطلحات طبية", "فسيولوجى", "تكنولوجيا المعلومات"],
        "second_year": ["تمريض بالغين 1 نظرى", "تمريض بالغين 1 عملى", "تمريض حالات حرجة 1 نظرى", "تمريض حالات حرجة 1 عملى", "امراض باطنة", "باثولوجى", "علم الأدوية", "الكتابة التقنية"]
    };

    function updateSubjects() {
        const yr = document.getElementById("yearSelect").value;
        const sub = document.getElementById("subjectSelect");
        sub.innerHTML = '<option value="" disabled selected>-- اختر المادة --</option>';
        if(subjects[yr]) {
            subjects[yr].forEach(s => {
                let opt = document.createElement("option");
                opt.value = s; opt.innerText = s;
                sub.appendChild(opt);
            });
            sub.disabled = false;
        }
    }

    function handleLogin() {
        const id = document.getElementById("uniID").value.trim();
        if (!id) return alert("اكتب الكود الجامعي");
        
        if (studentsDB[id]) {
            userData.id = id;
            userData.name = studentsDB[id];
            document.getElementById("stName").innerText = userData.name;
            document.getElementById("stID").innerText = id;
            
            document.getElementById("screenWelcome").classList.remove("active");
            document.getElementById("screenScan").classList.add("active");
        } else {
            if (Object.keys(studentsDB).length === 0) {
                document.getElementById("loginBtn").innerHTML = "جاري تحميل الأسماء...";
                setTimeout(handleLogin, 2000);
            } else {
                alert("الكود غير صحيح");
            }
        }
    }

    function startCamera() {
        document.getElementById("camBtn").style.display = "none";
        document.getElementById("qr-reader").style.display = "block";
        const html5QrCode = new Html5Qrcode("qr-reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
            html5QrCode.stop();
            document.getElementById("qr-reader").style.display = "none";
            document.getElementById("qrStatus").style.display = "block";
            document.getElementById("qrResult").value = decodedText;
            document.getElementById("submitBtn").disabled = false;
            document.getElementById("submitBtn").style.opacity = "1";
            if(navigator.vibrate) navigator.vibrate(200);
        }).catch(err => alert("خطأ في الكاميرا"));
    }

    async function submitToGoogleForms() {
        const sub = document.getElementById("subjectSelect").value;
        const qr = document.getElementById("qrResult").value;
        
        if (!sub) return alert("اختر المادة أولاً");
        
        const btn = document.getElementById("submitBtn");
        btn.innerHTML = "جاري الإرسال...";
        btn.disabled = true;

        const formData = new URLSearchParams();
        formData.append(ENTRY_ID, userData.id);
        formData.append(ENTRY_NAME, userData.name);
        formData.append(ENTRY_SUBJECT, sub);
        formData.append(ENTRY_QR, qr);

        try {
            // Send blind request (no-cors) to bypass browser restrictions
            await fetch(GOOGLE_FORM_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: formData.toString()
            });

            // Success (Immediate)
            document.getElementById("receiptName").innerText = userData.name;
            document.getElementById("receiptSubject").innerText = sub;
            document.getElementById("receiptDate").innerText = new Date().toLocaleDateString('en-GB');
            document.getElementById("receiptTime").innerText = new Date().toLocaleTimeString();
            
            document.getElementById("screenScan").classList.remove("active");
            document.getElementById("screenSuccess").classList.add("active");
            
            if(window.confetti) confetti();

        } catch (e) {
            console.error(e);
            btn.innerHTML = "تأكيد الحضور";
            btn.disabled = false;
            alert("حدث خطأ في الشبكة، ولكن حاول التحقق من المشرف.");
        }
    }

    window.addEventListener('offline', () => document.getElementById('connectionLostModal').style.display = 'flex');
    window.addEventListener('online', () => document.getElementById('connectionLostModal').style.display = 'none');
</script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</body>
</html>